# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/zarf/main/zarf.schema.json
kind: ZarfPackageConfig
metadata:
  name: keycloak-config-wrapper
  version: "0.0.1"

components:
  - name: keycloak-config-wrapper
    required: true
    description: Loads a local jar file into the cluster via zarf data injection.
    only:
      cluster:
        architecture: amd64
    manifests:
      #create a job from the pre-existing init image
      - name: data-loader
        namespace: keycloak
        files: 
          - init-job.yaml
    dataInjections:
      - source: tmp_deploy
        target:
          namespace: keycloak
          selector: app=data-loader
          container: uds-config-loader
          path: /home/nonroot
        compress: false
    actions:
      onDeploy:
        before:
          # cleanup output from previous attempts
          - cmd: |
              rm -rf tmp_deploy
              mkdir tmp_deploy
          
          # Check deploy system arch
          - cmd: if [ "$(uname -m)" != "x86_64" ]; then echo "this package architecture is amd64, but the target system has a different architecture. These architectures must be the same" && exit 1; fi
            description: Check that the host architecture matches the package architecture
            maxRetries: 0

          # populate workdir
          - cmd: cp *.jar tmp_deploy/
        
        # CLEANUP attempted deploys
        onSuccess:
          - cmd: rm -rf tmp_deploy
        onFailure:
          - cmd: rm -rf tmp_deploy